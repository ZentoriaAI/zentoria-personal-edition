// Prisma Schema for MCP Gateway

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// API Keys for authentication
model ApiKey {
  id                 String    @id
  userId             String    @map("user_id")
  userEmail          String    @map("user_email")
  name               String
  scopes             String[]
  hashedKey          String    @map("hashed_key")
  prefix             String    // First 12 chars for lookup
  lastUsedAt         DateTime? @map("last_used_at")
  expiresAt          DateTime? @map("expires_at")
  rateLimitPerMinute Int?      @map("rate_limit_per_minute")
  rateLimitPerDay    Int?      @map("rate_limit_per_day")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@index([prefix])
  @@index([userId])
  @@map("api_keys")
}

// File metadata
model File {
  id         String   @id
  userId     String   @map("user_id")
  filename   String
  mimeType   String   @map("mime_type")
  size       Int
  purpose    String   @default("ai-input")
  checksum   String
  objectName String   @map("object_name") // MinIO path
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, purpose])
  @@index([createdAt])
  // PERF-010: Composite index for paginated user file queries
  @@index([userId, createdAt])
  @@map("files")
}

// Audit log
model AuditLog {
  id        String   @id @default(cuid())
  action    String
  userId    String?  @map("user_id")
  metadata  Json     @default("{}")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// Command history (optional persistence)
model CommandHistory {
  id           String   @id
  userId       String   @map("user_id")
  sessionId    String?  @map("session_id")
  command      String
  response     String?
  model        String
  promptTokens Int      @map("prompt_tokens")
  completionTokens Int  @map("completion_tokens")
  status       String   @default("completed")
  durationMs   Int?     @map("duration_ms")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("command_history")
}

// Workflow executions
model WorkflowExecution {
  id          String   @id
  userId      String   @map("user_id")
  workflowId  String   @map("workflow_id")
  status      String   @default("queued")
  payload     Json     @default("{}")
  result      Json?
  error       String?
  startedAt   DateTime @default(now()) @map("started_at")
  finishedAt  DateTime? @map("finished_at")

  @@index([userId])
  @@index([workflowId])
  @@index([status])
  @@map("workflow_executions")
}

// Email sending history
model EmailHistory {
  id         String   @id
  userId     String   @map("user_id")
  recipients String[] // To addresses
  subject    String
  status     String   @default("sent")
  messageId  String?  @map("message_id")
  error      String?
  sentAt     DateTime @default(now()) @map("sent_at")

  @@index([userId])
  @@index([sentAt])
  @@map("email_history")
}
