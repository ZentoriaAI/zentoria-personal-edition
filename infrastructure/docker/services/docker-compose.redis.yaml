version: '3.8'

services:
  # Redis 7 with persistence
  redis:
    image: redis:7-alpine
    container_name: zentoria-redis
    hostname: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-changeme}
      --appendonly yes
      --appendfsync everysec
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --loglevel ${REDIS_LOG_LEVEL:-notice}
    volumes:
      - redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - zentoria
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    resources:
      limits:
        cpus: '1'
        memory: 512M
      reservations:
        cpus: '0.5'
        memory: 256M

  # Redis Insight UI for monitoring and management
  redis-insight:
    image: redis/redisinsight:latest
    container_name: zentoria-redis-insight
    hostname: redis-insight
    restart: unless-stopped
    ports:
      - "5540:5540"
    environment:
      REDISINSIGHT_LOGGER_LEVEL: ${INSIGHT_LOG_LEVEL:-debug}
      REDISINSIGHT_PORT: 5540
    volumes:
      - redis_insight_data:/data
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - zentoria
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5540/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    resources:
      limits:
        cpus: '0.5'
        memory: 256M
      reservations:
        cpus: '0.25'
        memory: 128M

networks:
  zentoria:
    name: zentoria
    driver: bridge
    external: true
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis_data:
    name: zentoria_redis_data
    driver: local
  redis_insight_data:
    name: zentoria_redis_insight_data
    driver: local
