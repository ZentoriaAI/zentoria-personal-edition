# Docker Compose Override - Local Development
# Copy to docker-compose.override.yaml to enable

# This file overrides production settings for local development
# Changes here are automatically applied by Docker Compose

version: '3.8'

services:
  # Override Database for easier debugging
  postgres:
    # Use local host port instead of container network
    ports:
      - "5432:5432"
    environment:
      POSTGRES_INITDB_ARGS: "-c shared_preload_libraries=pgvector -c log_statement=all -c log_duration=on"
      POSTGRES_LOG_MIN_DURATION: 0
    volumes:
      - ./init/dev-seed.sql:/docker-entrypoint-initdb.d/99-seed.sql:ro

  pgbouncer:
    ports:
      - "6432:6432"

  # Override Redis for development
  redis:
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-changeme}
      --appendonly yes
      --loglevel debug
      --maxmemory 512mb

  redis-insight:
    ports:
      - "5540:5540"

  # Override Vault for development
  vault:
    environment:
      VAULT_LOG_LEVEL: debug
    volumes:
      - ./vault/dev-config:/vault/config

  # Override Prometheus for development
  prometheus:
    ports:
      - "9090:9090"
    environment:
      PROMETHEUS_RETENTION: 7d
    volumes:
      - ./prometheus/dev-prometheus.yml:/etc/prometheus/prometheus.yml:ro

  # Override Grafana for development
  grafana:
    ports:
      - "3000:3000"
    environment:
      GF_LOG_LEVEL: debug
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "true"

  # Override Loki for development
  loki:
    ports:
      - "3100:3100"
    environment:
      LOKI_LOG_LEVEL: debug

  # Override MinIO for development
  minio:
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_PASSWORD: minioadmin
    command: server --console-address ":9001" /data

  # Override n8n for development
  n8n:
    ports:
      - "5678:5678"
    environment:
      N8N_LOG_LEVEL: debug
      N8N_SECURE_COOKIE: "false"
      WEBHOOK_URL: "http://localhost:5678"
      NODE_OPTIONS: "--max_old_space_size=2048"

  # Override Ollama for development
  ollama:
    ports:
      - "11434:11434"
    environment:
      OLLAMA_DEBUG: "true"
    volumes:
      - ./ollama/dev-models:/root/.ollama/models

  # Override Open WebUI for development
  open-webui:
    ports:
      - "8080:8080"
    environment:
      WEBUI_SECRET_KEY: dev-secret-key

  # Override Qdrant for development
  qdrant:
    ports:
      - "6333:6333"
    environment:
      QDRANT_LOG_LEVEL: debug

  # Override Paperless for development
  paperless-ngx:
    ports:
      - "8000:8000"
    environment:
      PAPERLESS_DEBUG: "true"
      PAPERLESS_LOG_LEVEL: debug

  # Override n8n worker with more verbosity
  n8n-worker:
    environment:
      N8N_LOG_LEVEL: debug

  # Override Whisper for development
  whisper-service:
    environment:
      WHISPER_LOG_LEVEL: debug
      WHISPER_MODEL: tiny

  # Override Piper for development
  piper-service:
    environment:
      PIPER_LOG_LEVEL: debug

  # Override Auth service for development
  auth-service:
    environment:
      AUTH_LOG_LEVEL: debug
      TLS_ENABLED: "false"

  # Override CrowdSec for development
  crowdsec:
    environment:
      LOGLEVEL: debug

  # Override NGINX for development
  nginx:
    environment:
      NGINX_LOGLEVEL: debug

  # Override Traefik for development
  traefik:
    environment:
      TRAEFIK_LOG_LEVEL: debug
      TRAEFIK_API_INSECURE: "true"
    ports:
      - "8080:8080"

  # Override Wiki.js for development
  wikijs:
    environment:
      LOGURU_LEVEL: debug

  # Override Documentation generator for development
  docs-generator:
    environment:
      DOCS_GEN_LOG_LEVEL: debug

# ============================================================================
# DEVELOPMENT-ONLY SERVICES
# ============================================================================

  # Add MailHog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: zentoria-mailhog
    hostname: mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - zentoria
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8025"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "1"

  # Add Adminer for database management
  adminer:
    image: adminer:latest
    container_name: zentoria-adminer
    hostname: adminer
    ports:
      - "8081:8080"
    depends_on:
      - postgres
    networks:
      - zentoria
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "1"

  # Add pgAdmin for PostgreSQL management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: zentoria-pgadmin
    hostname: pgadmin
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@zentoria.ai
      PGADMIN_DEFAULT_PASSWORD: admin
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - zentoria
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/misc/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "1"

  # Add PgBouncer Admin Console
  pgbouncer-admin:
    image: ghcr.io/gfmio/pgbouncer-ui:latest
    container_name: zentoria-pgbouncer-admin
    hostname: pgbouncer-admin
    ports:
      - "8082:80"
    environment:
      DATABASE_URL: "postgres://pgbouncer:changeme@pgbouncer:6432/pgbouncer?sslmode=disable"
    depends_on:
      - pgbouncer
    networks:
      - zentoria
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "1"

volumes:
  pgadmin_data:
    name: zentoria_pgadmin_data_dev
    driver: local

# Keep reference to external network
networks:
  zentoria:
    name: zentoria
    driver: bridge
    external: false
