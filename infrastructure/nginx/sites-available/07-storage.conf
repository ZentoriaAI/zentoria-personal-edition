############################################################################
# MinIO S3 Storage (files.zentoria.local & s3.zentoria.local)
# Container: 407 (zentoria-files)
# Port: 9001 (MinIO UI/Console)
# Port: 9000 (MinIO S3 API)
# Updated: 2026-01-16
############################################################################

server {
    listen 80;
    listen [::]:80;
    server_name files.zentoria.local s3.zentoria.local;

    return 301 https://$host$request_uri;
}

# MinIO Console UI
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name files.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/minio-ui-access.log main;
    error_log /var/log/nginx/minio-ui-error.log warn;

    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 40;

    client_max_body_size 100M;

    add_header Cache-Control "no-store, no-cache, must-revalidate";

    # Health Check
    location /health {
        access_log off;
        proxy_pass http://zentoria_minio_ui/health;
        proxy_connect_timeout 5s;
    }

    # MinIO Console Interface
    location / {
        proxy_pass http://zentoria_minio_ui;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        # WebSocket support for console
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_buffering off;
    }

    # Static Assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        proxy_pass http://zentoria_minio_ui;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        expires 1h;
        add_header Cache-Control "public, max-age=3600";

        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # API Endpoints
    location /api/ {
        proxy_pass http://zentoria_minio_ui;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

# MinIO S3 API
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name s3.zentoria.local *.s3.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/minio-s3-access.log main;
    error_log /var/log/nginx/minio-s3-error.log warn;

    limit_req zone=api_limit burst=30 nodelay;
    limit_conn conn_limit 50;

    # Large file uploads
    client_max_body_size 100M;
    client_body_buffer_size 10M;

    add_header Cache-Control "no-store, no-cache, must-revalidate";
    add_header X-Powered-By "MinIO";

    # Health Check
    location /health {
        access_log off;
        proxy_pass http://zentoria_minio_api/health;
        proxy_connect_timeout 5s;
    }

    # S3 API Endpoints
    location / {
        proxy_pass http://zentoria_minio_api;
        proxy_http_version 1.1;

        # Important for S3 API
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        # S3 Signature
        proxy_set_header Authorization $http_authorization;

        # Timeouts for file operations
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Buffering for large files
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 32 8k;
        proxy_max_temp_file_size 2048m;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # PUT/POST for uploads - Disable buffering
    location ~ ^/[^/]+/[^/]+ {
        limit_req zone=api_file_upload burst=5 nodelay;

        proxy_pass http://zentoria_minio_api;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;

        # Very long timeout for large uploads
        proxy_connect_timeout 10s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        # Disable request buffering for uploads
        proxy_request_buffering off;
        proxy_buffering off;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Multipart Upload
    location ~ ^/[^/]+/[^/]+\?uploads {
        proxy_pass http://zentoria_minio_api;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;

        proxy_connect_timeout 10s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        proxy_request_buffering off;
        proxy_buffering off;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # GET requests - Enable caching for objects
    location ~ ^/[^/]+/[^/]+ {
        limit_req zone=api_limit burst=50 nodelay;

        proxy_pass http://zentoria_minio_api;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Range $http_range;

        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Cache responses
        proxy_cache_key "$scheme$proxy_host$request_uri";
        expires 7d;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        if ($request_method != GET) {
            proxy_request_buffering off;
            proxy_buffering off;
        }
    }
}
