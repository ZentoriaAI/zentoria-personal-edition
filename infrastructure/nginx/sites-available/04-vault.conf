############################################################################
# HashiCorp Vault Service (vault.zentoria.local)
# Container: 403 (zentoria-vault)
# Port: 8200
# Updated: 2026-01-16
############################################################################

server {
    listen 80;
    listen [::]:80;
    server_name vault.zentoria.local;

    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name vault.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/vault-access.log main;
    error_log /var/log/nginx/vault-error.log warn;

    # Stricter rate limiting for Vault
    limit_req zone=api_strict burst=10 nodelay;
    limit_conn conn_limit 20;

    client_max_body_size 10M;

    # Security Headers for Vault
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;

    # Health Check Endpoint
    location /v1/sys/health {
        access_log off;
        proxy_pass http://zentoria_vault;
        proxy_connect_timeout 5s;
    }

    # UI Interface
    location / {
        proxy_pass http://zentoria_vault;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # API Endpoints - Vault REST API
    location /v1/ {
        limit_req zone=api_strict burst=5 nodelay;

        proxy_pass http://zentoria_vault;
        proxy_http_version 1.1;

        # Important Headers for Vault
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        # Allow Vault Token via header
        proxy_set_header X-Vault-Token $http_x_vault_token;
        proxy_set_header X-Vault-Request "true";

        # Vault-specific timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Vault requires connection reuse
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Auth method endpoints
        location ~ ^/v1/auth/ {
            limit_req zone=api_strict burst=3 nodelay;
            proxy_pass http://zentoria_vault;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Vault-Token $http_x_vault_token;

            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;

            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # Secret engine endpoints
        location ~ ^/v1/secret/ {
            proxy_pass http://zentoria_vault;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Vault-Token $http_x_vault_token;

            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;

            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }

    # Catch-all
    location ~ /\.git {
        deny all;
    }
}
