############################################################################
# Cache & RAG Services (redis.zentoria.local, ocr.zentoria.local,
# voice.zentoria.local, rag.zentoria.local, qdrant.zentoria.local)
# Containers: 410 (redis), 412 (ocr), 413 (voice), 419 (embeddings)
# Updated: 2026-01-16
############################################################################

server {
    listen 80;
    listen [::]:80;
    server_name redis.zentoria.local ocr.zentoria.local voice.zentoria.local
               rag.zentoria.local qdrant.zentoria.local;

    return 301 https://$host$request_uri;
}

# Redis Commander UI
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name redis.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/redis-access.log main;
    error_log /var/log/nginx/redis-error.log warn;

    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 25;

    add_header Cache-Control "no-store, no-cache, must-revalidate";
    add_header X-Frame-Options "DENY" always;

    location / {
        proxy_pass http://zentoria_redis;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

# OCR Service
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ocr.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/ocr-access.log main;
    error_log /var/log/nginx/ocr-error.log warn;

    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 30;

    client_max_body_size 50M;

    add_header Cache-Control "no-store, no-cache, must-revalidate";

    # Health Check
    location /health {
        access_log off;
        proxy_pass http://zentoria_ocr/health;
        proxy_connect_timeout 5s;
    }

    # OCR Processing - Long timeouts
    location /api/v1/ocr {
        proxy_pass http://zentoria_ocr;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        # OCR can take time
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Document Upload
    location /api/v1/upload {
        limit_req zone=api_file_upload burst=3 nodelay;

        proxy_pass http://zentoria_ocr;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_request_buffering off;
    }

    # General API
    location /api/ {
        proxy_pass http://zentoria_ocr;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

# Voice/Audio Processing Service
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name voice.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/voice-access.log main;
    error_log /var/log/nginx/voice-error.log warn;

    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 30;

    client_max_body_size 100M;

    add_header Cache-Control "no-store, no-cache, must-revalidate";

    # Health Check
    location /health {
        access_log off;
        proxy_pass http://zentoria_voice/health;
        proxy_connect_timeout 5s;
    }

    # Speech-to-Text
    location /api/v1/stt {
        proxy_pass http://zentoria_voice;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Text-to-Speech
    location /api/v1/tts {
        proxy_pass http://zentoria_voice;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_buffering off;
    }

    # Upload Audio
    location /api/v1/upload {
        limit_req zone=api_file_upload burst=3 nodelay;

        proxy_pass http://zentoria_voice;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_request_buffering off;
    }

    # General API
    location /api/ {
        proxy_pass http://zentoria_voice;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

# RAG Embeddings Service
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name rag.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/rag-access.log main;
    error_log /var/log/nginx/rag-error.log warn;

    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 30;

    client_max_body_size 50M;

    add_header Cache-Control "no-store, no-cache, must-revalidate";

    # Health Check
    location /health {
        access_log off;
        proxy_pass http://zentoria_embeddings/health;
        proxy_connect_timeout 5s;
    }

    # Embedding Generation
    location /api/v1/embed {
        proxy_pass http://zentoria_embeddings;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Vector Search
    location /api/v1/search {
        limit_req zone=search_limit burst=20 nodelay;

        proxy_pass http://zentoria_embeddings;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # General API
    location /api/ {
        proxy_pass http://zentoria_embeddings;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

# Qdrant Vector Database
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name qdrant.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/qdrant-access.log main;
    error_log /var/log/nginx/qdrant-error.log warn;

    limit_req zone=api_limit burst=30 nodelay;
    limit_conn conn_limit 40;

    client_max_body_size 50M;

    add_header Cache-Control "no-store, no-cache, must-revalidate";

    # Health Check
    location /health {
        access_log off;
        proxy_pass http://zentoria_qdrant/health;
        proxy_connect_timeout 5s;
    }

    # Qdrant API
    location / {
        proxy_pass http://zentoria_qdrant;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Collections Operations
    location /collections {
        proxy_pass http://zentoria_qdrant;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Points/Search Operations
    location /points {
        limit_req zone=search_limit burst=30 nodelay;

        proxy_pass http://zentoria_qdrant;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
