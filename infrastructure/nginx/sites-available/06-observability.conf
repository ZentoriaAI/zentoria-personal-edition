############################################################################
# Observability Stack (logs.zentoria.local & prometheus.zentoria.local)
# Container: 406 (zentoria-logs)
# Port: 3001 (Loki/Logs UI)
# Port: 9090 (Prometheus Metrics)
# Updated: 2026-01-16
############################################################################

server {
    listen 80;
    listen [::]:80;
    server_name logs.zentoria.local prometheus.zentoria.local;

    return 301 https://$host$request_uri;
}

# Loki Logs Service
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name logs.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/logs-access.log main;
    error_log /var/log/nginx/logs-error.log warn;

    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 30;

    # Large query results
    client_max_body_size 50M;
    proxy_buffer_size 4k;
    proxy_buffers 24 4k;

    add_header Cache-Control "no-store, no-cache, must-revalidate";

    location / {
        proxy_pass http://zentoria_logs;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # API Endpoints
    location /api/ {
        proxy_pass http://zentoria_logs;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        # Long queries might take time
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Query Endpoint - Can be resource intensive
    location /api/prom/query {
        proxy_pass http://zentoria_logs;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

# Prometheus Metrics Service
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name prometheus.zentoria.local;

    ssl_certificate /etc/nginx/ssl/zentoria.crt;
    ssl_certificate_key /etc/nginx/ssl/zentoria.key;

    access_log /var/log/nginx/prometheus-access.log main;
    error_log /var/log/nginx/prometheus-error.log warn;

    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 30;

    client_max_body_size 50M;

    add_header Cache-Control "no-store, no-cache, must-revalidate";

    # Health Check
    location /-/healthy {
        access_log off;
        proxy_pass http://zentoria_prometheus/-/healthy;
        proxy_connect_timeout 5s;
    }

    # Readiness Check
    location /-/ready {
        access_log off;
        proxy_pass http://zentoria_prometheus/-/ready;
        proxy_connect_timeout 5s;
    }

    # Metrics Service
    location / {
        proxy_pass http://zentoria_prometheus;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id_val;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # API Endpoints
    location /api/ {
        proxy_pass http://zentoria_prometheus;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Query operations can be slow
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Query Range Endpoint
    location /api/v1/query_range {
        proxy_pass http://zentoria_prometheus;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Metrics Endpoint (for scraping)
    location /metrics {
        proxy_pass http://zentoria_prometheus/metrics;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Configuration Endpoint
    location /config {
        proxy_pass http://zentoria_prometheus;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # Targets Endpoint
    location /targets {
        proxy_pass http://zentoria_prometheus;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # Service Discovery
    location /service-discovery {
        proxy_pass http://zentoria_prometheus;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
}
