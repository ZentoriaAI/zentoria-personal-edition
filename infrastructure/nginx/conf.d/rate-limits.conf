############################################################################
# NGINX Rate Limiting Configuration
# Zentoria Personal Edition
# Updated: 2026-01-16
############################################################################

# API Rate Limiting
limit_req_zone $limit_api zone=api_limit:10m rate=100r/s;
limit_req_zone $limit_api zone=api_strict:10m rate=10r/s;
limit_req_zone $limit_api zone=api_file_upload:10m rate=5r/m;

# Authentication/Login Rate Limiting
limit_req_zone $limit_login zone=login_limit:10m rate=5r/m;
limit_req_zone $limit_login zone=token_refresh:10m rate=20r/m;

# Search/Query Rate Limiting
limit_req_zone $limit_api zone=search_limit:10m rate=30r/m;

# WebSocket Connection Limiting
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# Connection Per IP
limit_conn conn_limit 100;

# Enable burst protection
limit_req_status 429;

# Configuration map for dynamic limits
map $request_uri $limit_zone {
    # API endpoints - standard limit
    ~^/api/v1/ "api_limit";

    # Strict endpoints
    ~^/api/v1/auth/ "api_strict";
    ~^/api/v1/security/ "api_strict";

    # File uploads - very strict
    ~^/api/v1/upload "api_file_upload";
    ~^/s3/ "api_file_upload";

    # Search - moderate limit
    ~^/api/v1/search "search_limit";
    ~^/api/v1/rag/search "search_limit";

    # Login endpoints
    ~^/auth/login "login_limit";
    ~^/api/v1/auth/login "login_limit";

    # Token refresh
    ~^/auth/refresh "token_refresh";
    ~^/api/v1/auth/refresh "token_refresh";

    default "api_limit";
}

# Skip rate limiting for internal/trusted IPs
map $client_ip $rate_limit_bypass {
    default 0;
    ~^127\.0\.0\.1$ 1;
    ~^10\.0\.0\.0/8$ 1;
    ~^172\.1[6-9]\.0\.0/12$ 1;
    ~^172\.2[0-9]\.0\.0/12$ 1;
    ~^172\.3[01]\.0\.0/12$ 1;
    ~^192\.168\.0\.0/16$ 1;
    ~^::1$ 1;
}

# Response Headers for Rate Limiting
map $limit_req_status $ratelimit_headers {
    default "";
    429 "X-RateLimit-Limit: 100|X-RateLimit-Remaining: 0|X-RateLimit-Reset: $sent_http_retry_after";
}

# DDoS Protection - Slow Client Detection
map $request_time $slow_request {
    default 0;
    ~^[2-9]\..*|[0-9]{2,}\..*$ 1;
}

# Bot Detection Map
map $http_user_agent $is_bot {
    default 0;
    ~*bot|crawler|spider|scraper|curl|wget|python-requests 1;
    ~*googlebot|bingbot|slurp|duckduckbot|baiduspider 0; # Allow major search engines
}
