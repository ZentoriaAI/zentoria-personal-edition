############################################################################
# NGINX Security Hardening Configuration
# Zentoria Personal Edition
# Updated: 2026-01-16
############################################################################

# Hide NGINX Version
server_tokens off;

# Prevent MIME Type Sniffing
add_header X-Content-Type-Options "nosniff" always;

# Enable XSS Protection
add_header X-XSS-Protection "1; mode=block" always;

# Clickjacking Protection
add_header X-Frame-Options "SAMEORIGIN" always;

# Referrer Policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (formerly Feature Policy)
add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy - Strict Mode
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https:; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

# Cross-Origin Policies
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "cross-origin" always;

# Disable Directory Listing
autoindex off;

# Remove Server Signature from Error Pages
error_page 404 404.html;
error_page 500 502 503 504 50x.html;

# SSL/TLS Configuration
ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

# Session Configuration
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;

# DH Parameters
ssl_dhparam /etc/nginx/ssl/dhparam.pem;

# Request Size Limits
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 5s 5s;
send_timeout 10s;

# IP Spoofing Protection
map $http_x_forwarded_for $client_ip {
    default $http_x_forwarded_for;
    "" $remote_addr;
}

# Bot Detection & Rate Limiting Variables
map $http_user_agent $bot_limit {
    default 1;
    ~*bot|crawler|spider 0;
}

# GeoIP Blocking (Optional - requires MaxMind GeoIP2)
# Uncomment and configure for geographic restrictions
# geo $geo_allowed {
#     default 0;
#     52.0 1;    # Netherlands latitude range
#     52.5 1;
# }

# Deny Request Methods
map $request_method $not_allowed_method {
    default 0;
    ~*TRACE|DELETE|PUT 1;
}

# CrowdSec Bouncer Integration
# Include external bouncer configuration if using CrowdSec
# include /etc/nginx/conf.d/crowdsec.conf;

# Request ID for Tracing
map $http_x_request_id $request_id_val {
    default $http_x_request_id;
    "" $msec;
}

add_header X-Request-ID $request_id_val;

# Security Event Variables
map $status $action {
    401 "UNAUTHORIZED";
    403 "FORBIDDEN";
    429 "RATE_LIMIT";
    444 "BLOCKED";
    default "OK";
}

map $status $blocked_reason {
    401 "Invalid credentials";
    403 "Access denied";
    429 "Rate limit exceeded";
    444 "Blocked by WAF";
    default "";
}
