# =============================================================================
# Zentoria Personal Edition - PostgreSQL Configuration
# Container: 404 (zentoria-db)
# PostgreSQL Version: 16
# Optimized for: 16GB RAM, 4 cores, SSD storage
# =============================================================================

# -----------------------------------------------------------------------------
# CONNECTION SETTINGS
# -----------------------------------------------------------------------------

# Listen on all interfaces (secured by firewall)
listen_addresses = '*'
port = 5432

# Maximum connections
# Backend: 20, n8n: 10, AI: 5, Admin: 5, Reserved: 10
max_connections = 100

# Unix socket
unix_socket_directories = '/var/run/postgresql'

# Authentication timeout
authentication_timeout = 60s

# SSL (recommended for production)
ssl = on
ssl_cert_file = '/etc/ssl/certs/ssl-cert-snakeoil.pem'
ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'

# -----------------------------------------------------------------------------
# MEMORY SETTINGS
# -----------------------------------------------------------------------------

# Shared memory (25% of RAM = 4GB for 16GB system)
shared_buffers = 4GB

# Work memory per operation (sort, hash)
# Total concurrent operations * work_mem should not exceed 25% of RAM
# 100 connections * 64MB = 6.4GB max (safe for 16GB system)
work_mem = 64MB

# Maintenance operations (vacuum, create index)
maintenance_work_mem = 1GB

# Effective cache size (75% of total RAM - hint for planner)
effective_cache_size = 12GB

# Huge pages (if enabled on host)
huge_pages = try

# -----------------------------------------------------------------------------
# WAL (Write-Ahead Log) SETTINGS
# -----------------------------------------------------------------------------

# WAL level for PITR and replication
wal_level = replica

# Synchronous commit (off for faster writes, on for durability)
synchronous_commit = on

# WAL buffers (default is usually fine)
wal_buffers = 64MB

# Checkpoint settings
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
max_wal_size = 4GB
min_wal_size = 1GB

# Archive mode (for PITR backups)
archive_mode = on
archive_command = 'test ! -f /opt/zentoria/db/wal_archive/%f && cp %p /opt/zentoria/db/wal_archive/%f'

# -----------------------------------------------------------------------------
# REPLICATION (Optional for personal edition)
# -----------------------------------------------------------------------------

# Max replication slots
max_replication_slots = 4

# Max WAL senders for streaming replication
max_wal_senders = 4

# Keep WAL for replication
wal_keep_size = 1GB

# -----------------------------------------------------------------------------
# QUERY PLANNER
# -----------------------------------------------------------------------------

# Random page cost (lower for SSD)
random_page_cost = 1.1

# Effective IO concurrency (SSD can handle many concurrent IOs)
effective_io_concurrency = 200

# Parallel query settings
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# JIT compilation (can improve complex queries)
jit = on

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------

# Logging destination
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# What to log
log_min_duration_statement = 1000  # Log queries taking > 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

# Log line prefix
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Statement logging (be careful in production)
log_statement = 'ddl'  # Log DDL statements only

# -----------------------------------------------------------------------------
# AUTOVACUUM
# -----------------------------------------------------------------------------

# Enable autovacuum
autovacuum = on

# Autovacuum settings
autovacuum_max_workers = 3
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.02
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.01

# Autovacuum resource limits
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 1000

# -----------------------------------------------------------------------------
# STATEMENT BEHAVIOR
# -----------------------------------------------------------------------------

# Search path
search_path = '"$user", public'

# Default tablespace
default_tablespace = ''

# Statement timeout (0 = no timeout, set per-session for long queries)
statement_timeout = 0

# Lock timeout
lock_timeout = 30s

# Idle transaction timeout
idle_in_transaction_session_timeout = 10min

# -----------------------------------------------------------------------------
# ERROR HANDLING
# -----------------------------------------------------------------------------

# Exit on PANIC
exit_on_error = off

# Restart after backend crash
restart_after_crash = on

# -----------------------------------------------------------------------------
# EXTENSIONS
# -----------------------------------------------------------------------------

# Preload shared libraries
shared_preload_libraries = 'pg_stat_statements,vector'

# pg_stat_statements settings
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.track_planning = on

# -----------------------------------------------------------------------------
# LOCALE
# -----------------------------------------------------------------------------

# Timezone
timezone = 'Europe/Amsterdam'
log_timezone = 'Europe/Amsterdam'

# Locale
lc_messages = 'en_US.UTF-8'
lc_monetary = 'nl_NL.UTF-8'
lc_numeric = 'nl_NL.UTF-8'
lc_time = 'nl_NL.UTF-8'

# Default text search config
default_text_search_config = 'pg_catalog.dutch'

# -----------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------

# Default encoding
client_encoding = 'UTF8'

# Date/time style
datestyle = 'iso, dmy'

# Interval output style
intervalstyle = 'postgres'

# -----------------------------------------------------------------------------
# RESOURCE USAGE
# -----------------------------------------------------------------------------

# Temporary file limit
temp_file_limit = 10GB

# Backend memory context limit (debugging)
# backend_memory_limit = 0

# -----------------------------------------------------------------------------
# DEVELOPER OPTIONS (DO NOT CHANGE IN PRODUCTION)
# -----------------------------------------------------------------------------

# Allow system table modifications (DO NOT ENABLE)
# allow_system_table_mods = off

# Debug assertions (only for development builds)
# debug_assertions = off
