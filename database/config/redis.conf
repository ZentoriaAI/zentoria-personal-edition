# =============================================================================
# Zentoria Personal Edition - Redis Configuration
# Container: 410 (zentoria-redis)
# Version: Redis 7.2+
# =============================================================================

# =============================================================================
# NETWORK
# =============================================================================

# Bind to all interfaces (secured by firewall)
bind 0.0.0.0

# Default port
port 6379

# TCP listen backlog
tcp-backlog 511

# Close connection after client idle N seconds (0 = disabled)
timeout 0

# TCP keepalive (recommended: 300)
tcp-keepalive 300

# =============================================================================
# GENERAL
# =============================================================================

# Run as daemon (set to yes for production)
daemonize no

# Supervised by systemd
supervised systemd

# PID file
pidfile /var/run/redis/redis-server.pid

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (empty for stdout)
logfile /var/log/redis/redis-server.log

# Number of databases (0-15)
databases 16

# Show Redis logo on startup
always-show-logo no

# =============================================================================
# SNAPSHOTTING (RDB)
# =============================================================================

# Save after 900 sec (15 min) if at least 1 key changed
save 900 1

# Save after 300 sec (5 min) if at least 10 keys changed
save 300 10

# Save after 60 sec if at least 10000 keys changed
save 60 10000

# Stop accepting writes on RDB save error
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# RDB checksum
rdbchecksum yes

# Sanitize ziplist entries for RDB and AOF
sanitize-dump-payload no

# RDB filename
dbfilename dump.rdb

# Remove RDB files used by replication in instances without persistence enabled
rdb-del-sync-files no

# Working directory
dir /var/lib/redis

# =============================================================================
# REPLICATION (Not used for single-node personal edition)
# =============================================================================

# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync yes
# repl-diskless-sync-delay 5

# =============================================================================
# SECURITY
# =============================================================================

# Require password (SET THIS IN PRODUCTION!)
# Use Vault to manage this password
requirepass ZENTORIA_REDIS_PASSWORD_CHANGE_ME

# Rename dangerous commands (empty string disables)
rename-command FLUSHALL "ZENTORIA_FLUSHALL_SECRET"
rename-command FLUSHDB "ZENTORIA_FLUSHDB_SECRET"
rename-command DEBUG ""
rename-command CONFIG "ZENTORIA_CONFIG_SECRET"
rename-command SHUTDOWN "ZENTORIA_SHUTDOWN_SECRET"

# ACL (Access Control List)
# Define users with specific permissions
# aclfile /etc/redis/users.acl

# =============================================================================
# CLIENTS
# =============================================================================

# Max number of connected clients
maxclients 1000

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Maximum memory (4GB recommended for personal edition)
maxmemory 4gb

# Eviction policy when maxmemory reached
# volatile-lru: Remove keys with TTL, least recently used first
maxmemory-policy volatile-lru

# LRU, LFU and minimal TTL algorithms are not precise but approximated
# Higher sample = more accurate but slower
maxmemory-samples 5

# Don't evict keys from replica nodes
replica-ignore-maxmemory yes

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# =============================================================================
# LAZY FREEING (Async deletion)
# =============================================================================

# Delete keys asynchronously (non-blocking)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# FLUSHDB/FLUSHALL async
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# =============================================================================
# APPEND ONLY MODE (AOF)
# =============================================================================

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# Directory for AOF files
appenddirname "appendonlydir"

# Fsync policy: always, everysec, no
# everysec = good balance of safety and performance
appendfsync everysec

# Don't fsync during BGSAVE or BGREWRITEAOF
no-appendfsync-on-rewrite no

# Auto rewrite AOF when it grows 100% over base size
auto-aof-rewrite-percentage 100

# Minimum AOF file size to trigger rewrite
auto-aof-rewrite-min-size 64mb

# Load truncated AOF on startup
aof-load-truncated yes

# Enable RDB-AOF hybrid persistence
aof-use-rdb-preamble yes

# Enable timestamp annotations in AOF
aof-timestamp-enabled no

# =============================================================================
# CLUSTER (Not used for personal edition)
# =============================================================================

# cluster-enabled no
# cluster-config-file nodes.conf
# cluster-node-timeout 15000

# =============================================================================
# SLOW LOG
# =============================================================================

# Log queries slower than N microseconds (10ms = 10000)
slowlog-log-slower-than 10000

# Maximum slow log entries
slowlog-max-len 128

# =============================================================================
# LATENCY MONITORING
# =============================================================================

# Log operations taking more than N ms (0 = disabled)
latency-monitor-threshold 100

# =============================================================================
# EVENT NOTIFICATION
# =============================================================================

# Notify keyspace events
# K = Keyspace events
# E = Keyevent events
# x = Expired events
# e = Evicted events
# g = Generic commands (DEL, EXPIRE, RENAME, ...)
# $ = String commands
# l = List commands
# s = Set commands
# h = Hash commands
# z = Sorted set commands
notify-keyspace-events "Kxe"

# =============================================================================
# ADVANCED CONFIG
# =============================================================================

# Hash optimization
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List optimization
list-max-listpack-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64

# Sorted set optimization
zset-max-listpack-entries 128
zset-max-listpack-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Stream optimization
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
# normal clients
client-output-buffer-limit normal 0 0 0
# replica clients
client-output-buffer-limit replica 256mb 64mb 60
# pubsub clients
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limit
client-query-buffer-limit 1gb

# Maximum single element request size
proto-max-bulk-len 512mb

# Hz (internal clock frequency)
hz 10

# Dynamic hz
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

# =============================================================================
# MODULES
# =============================================================================

# Load Redis modules (if needed)
# loadmodule /path/to/module.so

# =============================================================================
# TLS/SSL (Optional, for encrypted connections)
# =============================================================================

# Uncomment and configure for TLS
# tls-port 6380
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt
# tls-auth-clients optional
