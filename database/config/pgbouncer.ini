; =============================================================================
; Zentoria Personal Edition - PgBouncer Connection Pooler Configuration
; Container: 404 (zentoria-db)
; PgBouncer Version: 1.22+
; =============================================================================

; -----------------------------------------------------------------------------
; DATABASE DEFINITIONS
; -----------------------------------------------------------------------------
[databases]

; Main application database
zentoria_main = host=127.0.0.1 port=5432 dbname=zentoria_main auth_user=pgbouncer

; Vector database for AI embeddings
zentoria_vectors = host=127.0.0.1 port=5432 dbname=zentoria_vectors auth_user=pgbouncer

; n8n workflow database
n8n = host=127.0.0.1 port=5432 dbname=n8n auth_user=pgbouncer

; Wildcard for any database (fallback)
* = host=127.0.0.1 port=5432 auth_user=pgbouncer

; -----------------------------------------------------------------------------
; CONNECTION POOLING SETTINGS
; -----------------------------------------------------------------------------
[pgbouncer]

; Address to listen on (all interfaces for container access)
listen_addr = 0.0.0.0

; Port to listen on (different from PostgreSQL)
listen_port = 6432

; Unix socket path
unix_socket_dir = /var/run/pgbouncer

; Authentication file
auth_file = /etc/pgbouncer/userlist.txt

; Authentication type (md5 or scram-sha-256)
auth_type = scram-sha-256

; Authentication query for dynamic user lookup
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

; -----------------------------------------------------------------------------
; POOL MODE
; -----------------------------------------------------------------------------

; Pool mode: session, transaction, or statement
; - session: Connection assigned to client for entire session (most compatible)
; - transaction: Connection returned to pool after each transaction (recommended)
; - statement: Connection returned after each statement (most aggressive)
pool_mode = transaction

; -----------------------------------------------------------------------------
; CONNECTION LIMITS
; -----------------------------------------------------------------------------

; Maximum client connections
max_client_conn = 500

; Default pool size per user/database pair
default_pool_size = 20

; Minimum pool size (keep this many connections ready)
min_pool_size = 5

; Reserve connections for superuser
reserve_pool_size = 5

; Timeout to use reserved connections
reserve_pool_timeout = 3

; Maximum connections to backend PostgreSQL per pool
max_db_connections = 50

; Maximum connections per user
max_user_connections = 50

; -----------------------------------------------------------------------------
; TIMEOUTS
; -----------------------------------------------------------------------------

; Close unused server connections after this time
server_idle_timeout = 60

; Query timeout for server connections
query_timeout = 120

; Maximum time to wait for server connection
server_connect_timeout = 15

; Time to wait for server to login
server_login_retry = 15

; Close client connection if idle too long
client_idle_timeout = 0

; Close client connection if login takes too long
client_login_timeout = 60

; Time between connection retries
dns_max_ttl = 15

; -----------------------------------------------------------------------------
; QUERY HANDLING
; -----------------------------------------------------------------------------

; Ignore errors from server after query is canceled
ignore_startup_parameters = extra_float_digits,geqo,application_name

; Track prepared statements in transaction mode
max_prepared_statements = 100

; Disable prepared statement tracking (for some ORMs)
; disable_pqexec = 0

; -----------------------------------------------------------------------------
; LOGGING
; -----------------------------------------------------------------------------

; Log file
logfile = /var/log/pgbouncer/pgbouncer.log

; Syslog settings
syslog = 0
; syslog_facility = daemon
; syslog_ident = pgbouncer

; Log connections/disconnections
log_connections = 1
log_disconnections = 1

; Log pooler errors
log_pooler_errors = 1

; Stats logging period
stats_period = 60

; Verbose mode (for debugging)
verbose = 0

; -----------------------------------------------------------------------------
; ADMIN ACCESS
; -----------------------------------------------------------------------------

; Admin users (can run SHOW, RELOAD, etc.)
admin_users = postgres,zentoria_admin

; Stats users (can run SHOW STATS, SHOW POOLS, etc.)
stats_users = postgres,zentoria_admin,pgbouncer

; -----------------------------------------------------------------------------
; PERFORMANCE TUNING
; -----------------------------------------------------------------------------

; TCP keepalive settings
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 60
tcp_keepintvl = 15

; Socket buffer sizes (0 = OS default)
tcp_socket_buffer = 0

; Packet buffer size
pkt_buf = 4096

; Read-only packets buffer size
sbuf_lookahead = 0

; Disable SO_REUSEPORT (set to 1 if load balancing multiple pgbouncers)
so_reuseport = 0

; -----------------------------------------------------------------------------
; TLS/SSL (Optional)
; -----------------------------------------------------------------------------

; Server-side TLS
; server_tls_sslmode = prefer
; server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt

; Client-side TLS
; client_tls_sslmode = prefer
; client_tls_cert_file = /etc/pgbouncer/server.crt
; client_tls_key_file = /etc/pgbouncer/server.key

; -----------------------------------------------------------------------------
; USERS SECTION (Alternative to auth_file)
; -----------------------------------------------------------------------------
; [users]
; zentoria_app = pool_mode=transaction max_user_connections=30
; n8n_app = pool_mode=transaction max_user_connections=15
; readonly = pool_mode=transaction max_user_connections=20
